<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>w4 í¬ìŠ¤íŒ… ì½˜ì†” (ë¡œì»¬)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system; margin: 24px; }
    h1 { margin: 0 0 12px; }
    fieldset { border: 1px solid #ccc; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
    legend { padding: 0 6px; font-weight: 600; }
    .row { display: flex; gap: 24px; }
    .col { flex: 1; min-width: 280px; }
    .list { max-height: 320px; overflow: auto; border: 1px solid #ddd; border-radius: 8px; padding: 8px; }
    .actions { display: flex; gap: 12px; align-items: center; }
    button { padding: 10px 16px; font-weight: 700; border-radius: 10px; border: 1px solid #222; background: #111; color: white; cursor: pointer; }
    button[disabled] { opacity: 0.6; cursor: not-allowed; }
    label.cb { display: flex; align-items: center; gap: 8px; padding: 6px 4px; border-radius: 6px; }
    label.cb:hover { background: #f6f6f6; }
    .muted { color: #666; font-size: 12px; }
    pre { white-space: pre-wrap; background: #0a0a0a; color: #e9e9e9; padding: 12px; border-radius: 10px; max-height: 420px; overflow: auto; }
    .pill { display:inline-block; border:1px solid #ddd; border-radius:999px; padding:2px 8px; font-size:12px; margin-right:6px; }
  </style>
</head>
<body>
  <h1>ğŸ§© w4 í¬ìŠ¤íŒ… ì½˜ì†”</h1>
  <p class="muted">ì‹œíŠ¸(JSON)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì½˜í…ì¸ IDë¥¼ ë¶ˆëŸ¬ì˜¤ê³ , ì²´í¬í•œ í”Œë«í¼ë§Œ ì—…ë¡œë“œí•©ë‹ˆë‹¤.</p>

  <div class="row">
    <div class="col">
      <fieldset>
        <legend>1) í”Œë«í¼ ì„ íƒ</legend>
        <div id="platforms" class="list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      </fieldset>

      <fieldset>
        <legend>2) ì˜µì…˜</legend>
        <label class="cb"><input type="checkbox" id="dryRun" /> Dry run (ì—…ë¡œë“œ ì—†ì´ ë Œë”/ê²€ì¦ë§Œ)</label>
      </fieldset>

      <div class="actions">
        <button id="runBtn">ì„ íƒí•œ í”Œë«í¼ìœ¼ë¡œ í¬ìŠ¤íŒ…</button>
        <span id="status" class="muted"></span>
      </div>
    </div>

    <div class="col">
      <fieldset>
        <legend>3) ì½˜í…ì¸  ì„ íƒ (ì½˜í…ì¸ ID ë‹¨ìœ„)</legend>
        <div id="contents" class="list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
        <div class="actions" style="margin-top:8px;">
          <button id="selectAll">ì „ì²´ ì„ íƒ</button>
          <button id="clearAll">ì „ì²´ í•´ì œ</button>
        </div>
        <p class="muted">â€» ì•„ë¬´ê²ƒë„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ì‹œíŠ¸ì˜ <b>ì „ì²´ ì½˜í…ì¸ </b>ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•©ë‹ˆë‹¤.</p>
      </fieldset>
    </div>
  </div>

  <fieldset>
    <legend>ì‹¤í–‰ ë¡œê·¸</legend>
    <pre id="log">(ì—¬ê¸°ì— ê²°ê³¼ ë¡œê·¸ê°€ í‘œì‹œë©ë‹ˆë‹¤)</pre>
  </fieldset>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    async function fetchJSON(url, init) {
      const res = await fetch(url, init);
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    function checkbox(id, label, value, name) {
      const el = document.createElement('label');
      el.className = 'cb';
      el.innerHTML = `<input type="checkbox" value="${value}" name="${name}" /> <span>${label}</span>`;
      el.dataset.value = value;
      return el;
    }

    function contentRow(item) {
      const el = document.createElement('label');
      el.className = 'cb';
      const pills = (item.platforms || []).map(p => `<span class="pill">${p}</span>`).join('');
      const title = item.title ? ` - ${item.title}` : '';
      el.innerHTML = `<input type="checkbox" value="${item.contentId}" name="contentIds" />
                      <span><b>${item.contentId}</b>${title}<br/><span class="muted">${pills}</span></span>`;
      el.dataset.value = item.contentId;
      return el;
    }

    async function loadPlatforms() {
      const box = $('#platforms');
      box.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
      const { ok, platforms, error } = await fetchJSON('/api/platforms');
      if (!ok) throw new Error(error || 'platforms load failed');
      box.innerHTML = '';
      for (const p of platforms) {
        box.appendChild(checkbox('pf-' + p, p, p, 'platforms'));
      }
      // ê¸°ë³¸: ëª¨ë‘ ì²´í¬
      $$('#platforms input[type=checkbox]').forEach(i => i.checked = true);
    }

    async function loadContents() {
      const box = $('#contents');
      box.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
      const { ok, contents, error } = await fetchJSON('/api/contents');
      if (!ok) throw new Error(error || 'contents load failed');
      box.innerHTML = '';
      for (const c of contents) {
        box.appendChild(contentRow(c));
      }
    }

    async function run() {
      $('#status').textContent = 'ì‹¤í–‰ ì¤‘â€¦';
      $('#runBtn').disabled = true;
      $('#log').textContent = '(ì‹¤í–‰ ì¤‘â€¦)';

      const platforms = $$('#platforms input[type=checkbox]:checked').map(i => i.value);
      const contentIds = $$('#contents input[type=checkbox]:checked').map(i => i.value);
      const dryRun = $('#dryRun').checked;

      if (!platforms.length) {
        $('#status').textContent = '';
        $('#runBtn').disabled = false;
        $('#log').textContent = 'âš ï¸ ìµœì†Œ 1ê°œ í”Œë«í¼ì„ ì„ íƒí•˜ì„¸ìš”.';
        return;
      }

      try {
        const payload = { platforms, contentIds, dryRun };
        const { ok, exitCode, stdout, stderr } = await fetchJSON('/api/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        $('#status').textContent = ok ? 'ì™„ë£Œ' : 'ì‹¤íŒ¨';
        const merged = [
          `ok=${ok} exitCode=${exitCode}`,
          stderr ? `\n[stderr]\n${stderr}` : '',
          stdout ? `\n[stdout]\n${stdout}` : ''
        ].join('\n');
        $('#log').textContent = merged.trim();
      } catch (e) {
        $('#status').textContent = 'ì—ëŸ¬';
        $('#log').textContent = (e?.message || e || 'failed').toString();
      } finally {
        $('#runBtn').disabled = false;
      }
    }

    $('#runBtn').addEventListener('click', run);
    $('#selectAll').addEventListener('click', () => {
      $$('#contents input[type=checkbox]').forEach(i => i.checked = true);
    });
    $('#clearAll').addEventListener('click', () => {
      $$('#contents input[type=checkbox]').forEach(i => i.checked = false);
    });

    // ì´ˆê¸° ë¡œë“œ
    (async function init() {
      try {
        await loadPlatforms();
        await loadContents();
        const health = await fetchJSON('/api/health');
        if (!health.ok) throw new Error('health failed');
      } catch (e) {
        $('#log').textContent = 'ì´ˆê¸°í™” ì‹¤íŒ¨: ' + (e?.message || e);
      }
    })();
  </script>
</body>
</html>
